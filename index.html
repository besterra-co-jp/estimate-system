<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ™ã‚¹ãƒ†ãƒ© è¦‹ç©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v3 (Supabaseç‰ˆ)</title>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif; background-color: #f0f4f8; color: #333; font-size: 14px; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        .login-box h1 {
            text-align: center;
            color: #1a365d;
            margin-bottom: 8px;
            font-size: 24px;
        }
        .login-box .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .login-box .form-group {
            margin-bottom: 20px;
        }
        .login-box label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #4a5568;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        .login-box input:focus {
            outline: none;
            border-color: #3182ce;
        }
        .login-box .btn-login {
            width: 100%;
            padding: 14px;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .login-box .btn-login:hover {
            background: #2c5282;
        }
        .login-error {
            color: #e53e3e;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆéè¡¨ç¤ºåˆæœŸï¼‰ */
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: flex; }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #1a365d 0%, #2c5282 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h1 { font-size: 20px; margin-bottom: 4px; }
        .sidebar-header span { font-size: 12px; opacity: 0.7; }
        .user-info {
            padding: 16px 20px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .user-info .name { font-weight: bold; margin-bottom: 4px; }
        .user-info .role { font-size: 12px; opacity: 0.7; }
        .nav-menu { padding: 16px 0; }
        .nav-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.15); border-left-color: #63b3ed; }
        .nav-item .icon { font-size: 18px; }
        .nav-item .badge {
            background: #e53e3e;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: auto;
        }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 8px 20px; }
        .nav-item.logout { margin-top: auto; color: #fc8181; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content { flex: 1; margin-left: 240px; min-height: 100vh; }
        .page-header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .page-header h2 { font-size: 20px; color: #2d3748; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .page-content { padding: 24px; }
        .page { display: none; }
        .page.active { display: block; }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #3182ce; color: white; }
        .btn-primary:hover { background: #2c5282; }
        .btn-success { background: #38a169; color: white; }
        .btn-success:hover { background: #2f855a; }
        .btn-warning { background: #d69e2e; color: white; }
        .btn-warning:hover { background: #b7791f; }
        .btn-outline { background: white; border: 1px solid #e2e8f0; color: #4a5568; }
        .btn-outline:hover { background: #f7fafc; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h3 { font-size: 16px; color: #2d3748; }
        .card-body { padding: 20px; }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-card .label { font-size: 13px; color: #718096; margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #2d3748; }
        .stat-card .change { font-size: 12px; margin-top: 8px; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left;
            padding: 12px 16px;
            background: #f7fafc;
            font-size: 12px;
            color: #718096;
            font-weight: bold;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table td { padding: 16px; border-bottom: 1px solid #e2e8f0; }
        .data-table tr:hover { background: #f7fafc; }
        .data-table tr.clickable { cursor: pointer; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-draft { background: #fed7d7; color: #c53030; }
        .status-submitted { background: #c6f6d5; color: #276749; }
        .status-pending { background: #feebc8; color: #c05621; }
        .status-approved { background: #bee3f8; color: #2b6cb0; }
        .status-rejected { background: #e2e8f0; color: #4a5568; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: bold; color: #4a5568; }
        .form-group .required { color: #e53e3e; }
        .form-control {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-control:focus { outline: none; border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.1); }
        select.form-control {
            appearance: none;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center white;
            padding-right: 36px;
        }
        .auto-display { background: #ebf8ff; padding: 10px 12px; border-radius: 6px; font-size: 13px; color: #2b6cb0; }

        /* ã‚¿ãƒ– */
        .tabs { display: flex; background: white; border-bottom: 1px solid #e2e8f0; margin: -24px -24px 24px -24px; padding: 0 24px; }
        .tab { padding: 16px 24px; cursor: pointer; border-bottom: 3px solid transparent; color: #718096; font-weight: 500; }
        .tab:hover { color: #2d3748; }
        .tab.active { color: #3182ce; border-bottom-color: #3182ce; font-weight: bold; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ */
        .spreadsheet { width: 100%; border-collapse: collapse; font-size: 13px; }
        .spreadsheet th { background: #edf2f7; padding: 10px 8px; text-align: center; font-weight: bold; color: #4a5568; border: 1px solid #e2e8f0; }
        .spreadsheet td { border: 1px solid #e2e8f0; padding: 0; }
        .spreadsheet input { width: 100%; padding: 8px 10px; border: none; font-size: 13px; font-family: inherit; }
        .spreadsheet input:focus { outline: none; background: #fffbeb; }
        .spreadsheet input[type="number"] { text-align: right; }
        .spreadsheet .col-no { width: 40px; text-align: center; background: #f7fafc; color: #718096; padding: 8px; }
        .spreadsheet .col-amount { background: #f7fafc; }
        .spreadsheet .col-amount input { background: transparent; font-weight: bold; }

        /* ä¸­é …ç›® */
        .category-header {
            background: #2c5282;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-top: 16px;
            border-radius: 6px 6px 0 0;
        }
        .category-header:first-of-type { margin-top: 0; }
        .category-header h4 { font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .category-content { border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 6px 6px; }
        .category-content.collapsed { display: none; }

        /* çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ« */
        .expense-table { width: 100%; border-collapse: collapse; }
        .expense-table th, .expense-table td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        .expense-table th { background: #f7fafc; font-weight: bold; color: #4a5568; }
        .expense-table .value { text-align: right; font-weight: bold; }
        .expense-table input { width: 70px; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 4px; text-align: right; }
        .expense-table .total-row { background: #ebf8ff; font-size: 16px; }

        /* ã‚µãƒãƒªãƒ¼ */
        .summary-box { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; border-radius: 8px; padding: 24px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .summary-item { text-align: center; }
        .summary-item .label { font-size: 12px; opacity: 0.8; margin-bottom: 6px; }
        .summary-item .value { font-size: 24px; font-weight: bold; }
        .summary-item .value.highlight { color: #63b3ed; }

        /* ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ */
        .workflow-box { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .workflow-box h4 { margin-bottom: 16px; color: #2d3748; }
        .workflow-status { display: flex; align-items: center; gap: 20px; margin-bottom: 16px; }
        .workflow-step { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .workflow-step .circle {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
        }
        .workflow-step .circle.pending { background: #e2e8f0; color: #718096; }
        .workflow-step .circle.current { background: #d69e2e; }
        .workflow-step .circle.done { background: #38a169; }
        .workflow-step .circle.rejected { background: #e53e3e; }
        .workflow-arrow { font-size: 24px; color: #cbd5e0; }
        .workflow-actions { display: flex; gap: 12px; margin-top: 16px; }

        /* é€šçŸ¥ */
        .notification-list { max-height: 400px; overflow-y: auto; }
        .notification-item {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .notification-item:hover { background: #f7fafc; }
        .notification-item .icon {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .notification-item .icon.approval { background: #c6f6d5; }
        .notification-item .icon.request { background: #feebc8; }
        .notification-item .icon.reject { background: #fed7d7; }
        .notification-item .content { flex: 1; }
        .notification-item .content h5 { margin-bottom: 4px; }
        .notification-item .content p { font-size: 13px; color: #718096; }
        .notification-item .time { font-size: 12px; color: #a0aec0; }
        .notification-item.unread { background: #ebf8ff; }

        /* ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« */
        .help-toggle { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; background: #3182ce; color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
        .help-toggle:hover { background: #2c5282; }
        .help-panel { position: fixed; right: -420px; top: 0; width: 400px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15); z-index: 200; transition: right 0.3s; overflow-y: auto; }
        .help-panel.active { right: 0; }
        .help-panel-header { background: #1a365d; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .help-panel-header h3 { font-size: 18px; }
        .help-panel-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .help-section { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .help-section h4 { color: #2c5282; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .help-section p { font-size: 13px; color: #4a5568; line-height: 1.7; margin-bottom: 8px; }
        .help-section ul { font-size: 13px; color: #4a5568; padding-left: 20px; line-height: 1.8; }
        .help-step { display: flex; gap: 12px; margin-bottom: 16px; }
        .help-step-num { width: 28px; height: 28px; background: #3182ce; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        .help-step-content { flex: 1; }
        .help-step-content h5 { font-size: 14px; margin-bottom: 4px; }
        .help-step-content p { font-size: 12px; color: #718096; }
        .help-tip { background: #fffbeb; border-left: 4px solid #d69e2e; padding: 12px; margin: 12px 0; font-size: 13px; }
        .help-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 150; display: none; }
        .help-overlay.active { display: block; }

        /* ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ */
        .step-guide { background: linear-gradient(135deg, #ebf8ff 0%, #e6fffa 100%); border: 2px solid #90cdf4; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .step-guide-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .step-guide-header h4 { color: #2b6cb0; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .step-progress { display: flex; gap: 8px; align-items: center; }
        .step-dot { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e0; }
        .step-dot.active { background: #3182ce; }
        .step-dot.done { background: #38a169; }
        .step-guide-content { background: white; border-radius: 8px; padding: 16px; }
        .step-guide-content p { font-size: 14px; color: #2d3748; margin-bottom: 12px; }
        .step-guide-content .next-action { display: flex; align-items: center; gap: 12px; background: #f0fff4; padding: 12px; border-radius: 6px; }
        .step-guide-content .next-action .icon { font-size: 24px; }
        .step-guide-content .next-action .text { font-size: 13px; color: #276749; }
        .step-guide-content .next-action .text strong { display: block; font-size: 14px; margin-bottom: 2px; }

        /* æœŸé–“å…¥åŠ› */
        .period-input-group { display: flex; gap: 8px; align-items: center; }
        .period-input-group select { padding: 10px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .period-input-group select:focus { outline: none; border-color: #3182ce; }
        .period-input-group .sep { color: #718096; font-size: 14px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #718096; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; }

        /* å°åˆ· */
        .print-preview { background: white; padding: 40px; max-width: 800px; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .print-preview h1 { text-align: center; font-size: 28px; letter-spacing: 0.5em; margin-bottom: 40px; }
        .print-preview .amount-box { border: 2px solid #333; padding: 20px; text-align: center; margin: 30px 0; }
        .print-preview .amount-box .value { font-size: 32px; font-weight: bold; }
        .print-preview table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .print-preview table th, .print-preview table td { border: 1px solid #333; padding: 10px; }
        .print-preview table th { background: #f0f0f0; width: 150px; }

        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .action-bar { display: flex; gap: 12px; margin-bottom: 16px; }

        @media print {
            .sidebar, .page-header, .tabs, .action-bar, .btn, .workflow-box { display: none !important; }
            .main-content { margin-left: 0; }
            .page-content { padding: 0; }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>BESTERRA</h1>
            <p class="subtitle">è¦‹ç©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
            <div class="login-error" id="loginError">ç¤¾å“¡ç•ªå·ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
            <div class="form-group">
                <label>ç¤¾å“¡ç•ªå·</label>
                <input type="text" id="loginId" placeholder="ä¾‹: 1001">
            </div>
            <div class="form-group">
                <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            <button class="btn-login" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div style="margin-top:24px;padding:16px;background:#f7fafc;border-radius:8px;border:1px solid #e2e8f0;">
                <p style="text-align:center;margin:0 0 12px 0;font-size:13px;font-weight:bold;color:#4a5568;">
                    ğŸ“‹ ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
                </p>
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#e2e8f0;">
                            <th style="padding:6px;text-align:left;border-radius:4px 0 0 0;">ç¤¾å“¡ç•ªå·</th>
                            <th style="padding:6px;text-align:left;">æ°å</th>
                            <th style="padding:6px;text-align:left;">æ¨©é™</th>
                            <th style="padding:6px;text-align:left;border-radius:0 4px 0 0;">PW</th>
                        </tr>
                    </thead>
                    <tbody style="color:#4a5568;">
                        <tr><td style="padding:5px;border-bottom:1px solid #e2e8f0;">1001</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">å±±ç”°å¤ªéƒ</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;"><span style="background:#c53030;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">ç®¡ç†è€…</span></td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">0001</td></tr>
                        <tr><td style="padding:5px;border-bottom:1px solid #e2e8f0;">1002</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">éˆ´æœ¨ä¸€éƒ</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;"><span style="background:#2b6cb0;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">ä¸€èˆ¬</span></td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">0001</td></tr>
                        <tr><td style="padding:5px;border-bottom:1px solid #e2e8f0;">1003</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">ç”°ä¸­èŠ±å­</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;"><span style="background:#2b6cb0;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">ä¸€èˆ¬</span></td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">0001</td></tr>
                        <tr><td style="padding:5px;border-bottom:1px solid #e2e8f0;">1004</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">ä½è—¤æ¬¡éƒ</td><td style="padding:5px;border-bottom:1px solid #e2e8f0;"><span style="background:#2b6cb0;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">ä¸€èˆ¬</span></td><td style="padding:5px;border-bottom:1px solid #e2e8f0;">0001</td></tr>
                        <tr><td style="padding:5px;">1005</td><td style="padding:5px;">é«˜æ©‹ç¾å’²</td><td style="padding:5px;"><span style="background:#c53030;color:white;padding:2px 6px;border-radius:4px;font-size:10px;">ç®¡ç†è€…</span></td><td style="padding:5px;">0001</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
    <div class="app-container" id="appContainer">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>BESTERRA</h1>
                <span>è¦‹ç©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
            </div>
            <div class="user-info">
                <div class="name" id="currentUserName">-</div>
                <div class="role" id="currentUserRole">-</div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <span class="icon">ğŸ“Š</span>
                    <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                </div>
                <div class="nav-item" onclick="showPage('list')">
                    <span class="icon">ğŸ“</span>
                    <span>è¦‹ç©ä¸€è¦§</span>
                </div>
                <div class="nav-item" onclick="createNewEstimate()">
                    <span class="icon">â•</span>
                    <span>æ–°è¦ä½œæˆ</span>
                </div>
                <div class="nav-item" onclick="showPage('approvals')">
                    <span class="icon">âœ…</span>
                    <span>æ‰¿èªä¾é ¼</span>
                    <span class="badge" id="approvalBadge" style="display:none;">0</span>
                </div>
                <div class="nav-item" onclick="showPage('notifications')">
                    <span class="icon">ğŸ””</span>
                    <span>é€šçŸ¥</span>
                    <span class="badge" id="notificationBadge" style="display:none;">0</span>
                </div>
                <div class="nav-divider"></div>
                <div class="nav-item" onclick="showPage('customers')" id="navCustomers" style="display:none;">
                    <span class="icon">ğŸ¢</span>
                    <span>é¡§å®¢ç®¡ç†</span>
                </div>
                <div class="nav-item" onclick="showPage('users')" id="navUsers" style="display:none;">
                    <span class="icon">ğŸ‘¥</span>
                    <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
                </div>
                <div class="nav-item" onclick="showPage('settings')">
                    <span class="icon">âš™ï¸</span>
                    <span>è¨­å®š</span>
                </div>
                <div class="nav-divider"></div>
                <div class="nav-item logout" onclick="logout()">
                    <span class="icon">ğŸšª</span>
                    <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                </div>
            </div>
        </nav>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div id="page-dashboard" class="page active">
                <div class="page-header">
                    <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="createNewEstimate()">â• æ–°è¦ä½œæˆ</button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">ä½œæˆä¸­</div>
                            <div class="value" id="stat-draft">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æ‰¿èªå¾…ã¡</div>
                            <div class="value" id="stat-pending">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æ‰¿èªæ¸ˆ</div>
                            <div class="value" id="stat-approved">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ä»Šæœˆåˆè¨ˆé‡‘é¡</div>
                            <div class="value" id="stat-total">Â¥0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>æœ€è¿‘ã®è¦‹ç©</h3>
                            <button class="btn btn-outline btn-sm" onclick="showPage('list')">ã™ã¹ã¦è¡¨ç¤º â†’</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å·¥äº‹å</th>
                                    <th>é¡§å®¢å</th>
                                    <th>é‡‘é¡</th>
                                    <th>çŠ¶æ…‹</th>
                                    <th>ç”³è«‹è€…</th>
                                    <th>æ›´æ–°æ—¥</th>
                                </tr>
                            </thead>
                            <tbody id="recent-estimates"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- è¦‹ç©ä¸€è¦§ -->
            <div id="page-list" class="page">
                <div class="page-header">
                    <h2>è¦‹ç©ä¸€è¦§</h2>
                    <div class="header-actions">
                        <input type="text" class="form-control" placeholder="ğŸ” æ¤œç´¢..." id="search-input" oninput="filterEstimates()" style="width:200px;">
                        <button class="btn btn-primary" onclick="createNewEstimate()">â• æ–°è¦ä½œæˆ</button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="action-bar">
                        <button class="btn btn-outline btn-sm" onclick="filterByStatus('')">ã™ã¹ã¦</button>
                        <button class="btn btn-outline btn-sm" onclick="filterByStatus('draft')">ä½œæˆä¸­</button>
                        <button class="btn btn-outline btn-sm" onclick="filterByStatus('pending')">æ‰¿èªå¾…ã¡</button>
                        <button class="btn btn-outline btn-sm" onclick="filterByStatus('approved')">æ‰¿èªæ¸ˆ</button>
                    </div>
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å·¥äº‹å</th>
                                    <th>é¡§å®¢å</th>
                                    <th>é‡‘é¡</th>
                                    <th>çŠ¶æ…‹</th>
                                    <th>ç”³è«‹è€…</th>
                                    <th>æ‰¿èªè€…</th>
                                    <th>æ›´æ–°æ—¥</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="all-estimates"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ‰¿èªä¾é ¼ -->
            <div id="page-approvals" class="page">
                <div class="page-header">
                    <h2>æ‰¿èªä¾é ¼ä¸€è¦§</h2>
                </div>
                <div class="page-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>ã‚ãªãŸã«æ‰¿èªä¾é ¼ãŒæ¥ã¦ã„ã‚‹è¦‹ç©</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å·¥äº‹å</th>
                                    <th>é¡§å®¢å</th>
                                    <th>é‡‘é¡</th>
                                    <th>ç”³è«‹è€…</th>
                                    <th>ç”³è«‹æ—¥</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="approval-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥ -->
            <div id="page-notifications" class="page">
                <div class="page-header">
                    <h2>é€šçŸ¥</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline btn-sm" onclick="markAllRead()">ã™ã¹ã¦æ—¢èª­ã«ã™ã‚‹</button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="card">
                        <div class="notification-list" id="notification-list"></div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
            <div id="page-users" class="page">
                <div class="page-header">
                    <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openUserModal()">â• ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ç¤¾å“¡ç•ªå·</th>
                                    <th>æ°å</th>
                                    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th>æ¨©é™</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="user-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- é¡§å®¢ç®¡ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
            <div id="page-customers" class="page">
                <div class="page-header">
                    <h2>é¡§å®¢ç®¡ç†</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openCustomerModal()">â• é¡§å®¢è¿½åŠ </button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>é¡§å®¢ã‚³ãƒ¼ãƒ‰</th>
                                    <th>é¡§å®¢å</th>
                                    <th>ä½æ‰€</th>
                                    <th>é›»è©±ç•ªå·</th>
                                    <th>æ‹…å½“è€…</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="customer-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- è¦‹ç©ç·¨é›† -->
            <div id="page-edit" class="page">
                <div class="page-header">
                    <h2 id="edit-page-title">æ–°è¦è¦‹ç©ä½œæˆ</h2>
                    <div class="header-actions">
                        <button class="btn btn-outline" onclick="showPage('list')">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
                        <button class="btn btn-outline" onclick="saveCurrentEstimate()">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn btn-success" onclick="showEditTab('output')">ğŸ“„ å‡ºåŠ›</button>
                    </div>
                </div>
                <div class="page-content">
                    <!-- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹ -->
                    <div class="workflow-box" id="workflowBox">
                        <h4>ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹</h4>
                        <div class="workflow-status" id="workflowStatus"></div>
                        <div class="workflow-actions" id="workflowActions"></div>
                    </div>

                    <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ -->
                    <div class="step-guide" id="stepGuide">
                        <div class="step-guide-header">
                            <h4>ğŸ“– æ“ä½œã‚¬ã‚¤ãƒ‰</h4>
                            <div class="step-progress">
                                <div class="step-dot active" id="dot1"></div>
                                <div class="step-dot" id="dot2"></div>
                                <div class="step-dot" id="dot3"></div>
                                <div class="step-dot" id="dot4"></div>
                            </div>
                        </div>
                        <div class="step-guide-content" id="stepGuideContent">
                            <p id="stepDescription">ã¾ãšã€é¡§å®¢å…ˆåã¨å·¥äº‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                            <div class="next-action">
                                <div class="icon">ğŸ‘‰</div>
                                <div class="text">
                                    <strong id="nextActionTitle">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>
                                    <span id="nextActionDesc">å¿…é ˆé …ç›®ï¼ˆ*ï¼‰ã‚’å…¥åŠ›ã—ãŸã‚‰ã€Œ2. åŸä¾¡å…¥åŠ›ã€ã‚¿ãƒ–ã¸é€²ã¿ã¾ã—ã‚‡ã†</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="showEditTab('basic')">1. åŸºæœ¬æƒ…å ±</div>
                        <div class="tab" onclick="showEditTab('cost')">2. åŸä¾¡å…¥åŠ›</div>
                        <div class="tab" onclick="showEditTab('expense')">3. çµŒè²»è¨­å®š</div>
                        <div class="tab" onclick="showEditTab('output')">4. ç¢ºèªãƒ»å‡ºåŠ›</div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div id="edit-basic" class="tab-panel active">
                        <div class="card">
                            <div class="card-header"><h3>åŸºæœ¬æƒ…å ±</h3></div>
                            <div class="card-body">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>é¡§å®¢å…ˆå <span class="required">*</span></label>
                                        <select class="form-control" id="customerSelect" onchange="updateCustomerInfo()">
                                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>é¡§å®¢æƒ…å ±</label>
                                        <div class="auto-display" id="customerInfo">-</div>
                                    </div>
                                    <div class="form-group">
                                        <label>æ—¥ä»˜</label>
                                        <input type="date" class="form-control" id="quoteDate">
                                    </div>
                                    <div class="form-group full-width">
                                        <label>å·¥äº‹å <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="projectName">
                                    </div>
                                    <div class="form-group full-width">
                                        <label>ç¾å ´ä½æ‰€</label>
                                        <input type="text" class="form-control" id="siteAddress">
                                    </div>
                                    <div class="form-group">
                                        <label>è¦‹ç©å·¥äº‹æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
                                        <div class="period-input-group">
                                            <select id="periodStartYear" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">å¹´</span>
                                            <select id="periodStartMonth" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">æœˆ</span>
                                            <select id="periodStartDay" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">æ—¥</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>è¦‹ç©å·¥äº‹æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
                                        <div class="period-input-group">
                                            <select id="periodEndYear" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">å¹´</span>
                                            <select id="periodEndMonth" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">æœˆ</span>
                                            <select id="periodEndDay" onchange="updatePeriodPreview()"></select>
                                            <span class="sep">æ—¥</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>æ‹…å½“äº‹å‹™æ‰€</label>
                                        <select class="form-control" id="office" onchange="updateOfficeInfo()">
                                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                            <option value="æœ¬ç¤¾">æœ¬ç¤¾</option>
                                            <option value="åƒè‘‰äº‹å‹™æ‰€">åƒè‘‰äº‹å‹™æ‰€</option>
                                            <option value="äº¬æµœäº‹å‹™æ‰€">äº¬æµœäº‹å‹™æ‰€</option>
                                            <option value="è¥¿æ—¥æœ¬äº‹å‹™æ‰€">è¥¿æ—¥æœ¬äº‹å‹™æ‰€</option>
                                            <option value="ä¹å·äº‹å‹™æ‰€">ä¹å·äº‹å‹™æ‰€</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>äº‹å‹™æ‰€æƒ…å ±</label>
                                        <div class="auto-display" id="officeInfo">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŸä¾¡å…¥åŠ› -->
                    <div id="edit-cost" class="tab-panel">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="addCategory()">â• ä¸­é …ç›®è¿½åŠ </button>
                            <button class="btn btn-outline" onclick="loadSampleData()">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼</button>
                        </div>
                        <div id="costCategories"></div>
                        <div class="card" style="margin-top:20px;">
                            <div class="card-body">
                                <div class="summary-box">
                                    <div class="summary-grid">
                                        <div class="summary-item">
                                            <div class="label">ç›´æ¥å·¥äº‹è²»åˆè¨ˆ</div>
                                            <div class="value highlight" id="totalDirectCost">Â¥0</div>
                                        </div>
                                        <div class="summary-item">
                                            <div class="label">ä¸­é …ç›®æ•°</div>
                                            <div class="value" id="categoryCount">0</div>
                                        </div>
                                        <div class="summary-item">
                                            <div class="label">é …ç›®æ•°</div>
                                            <div class="value" id="itemCount">0</div>
                                        </div>
                                        <div class="summary-item"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- çµŒè²»è¨­å®š -->
                    <div id="edit-expense" class="tab-panel">
                        <div class="card">
                            <div class="card-header"><h3>è‡ªå‹•è¨ˆç®—çµŒè²»</h3></div>
                            <div class="card-body">
                                <table class="expense-table">
                                    <thead>
                                        <tr><th>é …ç›®</th><th>è¨ˆç®—å¼</th><th style="width:120px;">ç‡</th><th style="width:150px;text-align:right;">é‡‘é¡</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>ç›´æ¥å·¥äº‹è²»</td><td>-</td><td>-</td><td class="value" id="expDirectCost">Â¥0</td></tr>
                                        <tr><td>å®‰å…¨å¯¾ç­–è²»</td><td>ç›´å·¥è²» Ã— ç‡</td><td><input type="number" id="safetyRate" value="2" step="0.1" onchange="calculateExpenses()"> %</td><td class="value" id="expSafety">Â¥0</td></tr>
                                        <tr><td>è«¸çµŒè²»</td><td>ç›´å·¥è²» Ã— ç‡</td><td><input type="number" id="overheadRate" value="15" step="0.5" onchange="calculateExpenses()"> %</td><td class="value" id="expOverhead">Â¥0</td></tr>
                                        <tr><td>åŠ´ç½ä¿é™º</td><td>æå‡ºé‡‘é¡ Ã— 0.24 Ã— 15/1000</td><td>-</td><td class="value" id="expInsurance">Â¥0</td></tr>
                                        <tr><td>æ³•å®šç¦åˆ©è²»</td><td>æå‡ºé‡‘é¡ Ã— äººä»¶è²»ç‡ Ã— 16.1%</td><td><input type="number" id="laborRate" value="24" step="1" onchange="calculateExpenses()"> %</td><td class="value" id="expWelfare">Â¥0</td></tr>
                                        <tr class="total-row"><td colspan="3"><strong>è¦‹ç©é‡‘é¡åˆè¨ˆ</strong></td><td class="value" id="expTotal">Â¥0</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- å‡ºåŠ› -->
                    <div id="edit-output" class="tab-panel">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
                            <button class="btn btn-outline" onclick="exportCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
                        </div>
                        <div class="print-preview">
                            <h1>å¾¡ è¦‹ ç© æ›¸</h1>
                            <div style="text-align:right;margin-bottom:30px;" id="previewDate"></div>
                            <div style="font-size:18px;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:20px;">
                                <span id="previewCustomer"></span> å¾¡ä¸­
                            </div>
                            <div class="amount-box">
                                <div style="font-size:14px;margin-bottom:8px;">è¦‹ç©é‡‘é¡ï¼ˆç¨æŠœï¼‰</div>
                                <div class="value" id="previewAmount"></div>
                            </div>
                            <p style="margin:20px 0;">ä¸‹è¨˜ã®é€šã‚Šå¾¡è¦‹ç©ç”³ã—ä¸Šã’ã¾ã™ã€‚</p>
                            <table>
                                <tr><th>ä»¶å</th><td id="previewProject"></td></tr>
                                <tr><th>ç´å…¥å ´æ‰€</th><td id="previewSite"></td></tr>
                                <tr><th>è¦‹ç©å·¥äº‹æœŸé–“</th><td id="previewPeriod"></td></tr>
                            </table>
                            <div style="margin-top:40px;text-align:right;">
                                <p>ãƒ™ã‚¹ãƒ†ãƒ©æ ªå¼ä¼šç¤¾</p>
                                <p id="previewOffice"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨­å®š -->
            <div id="page-settings" class="page">
                <div class="page-header"><h2>è¨­å®š</h2></div>
                <div class="page-content">
                    <div class="card">
                        <div class="card-header"><h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3></div>
                        <div class="card-body">
                            <div class="form-group" style="max-width:300px;">
                                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" class="form-control" id="newPassword">
                            </div>
                            <button class="btn btn-primary" onclick="changePassword()" style="margin-top:12px;">å¤‰æ›´ã™ã‚‹</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3></div>
                        <div class="card-body">
                            <button class="btn btn-outline" onclick="exportAllData()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                            <button class="btn btn-outline" onclick="importAllData()">ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
    <button class="help-toggle" onclick="toggleHelp()" title="æ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«">â“</button>

    <!-- ãƒ˜ãƒ«ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="help-overlay" id="helpOverlay" onclick="toggleHelp()"></div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« -->
    <div class="help-panel" id="helpPanel">
        <div class="help-panel-header">
            <h3>ğŸ“– æ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>
            <button class="help-panel-close" onclick="toggleHelp()">&times;</button>
        </div>

        <div class="help-section">
            <h4>ğŸš€ è¦‹ç©ä½œæˆã®æµã‚Œ</h4>
            <div class="help-step">
                <div class="help-step-num">1</div>
                <div class="help-step-content">
                    <h5>åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›</h5>
                    <p>é¡§å®¢å…ˆåã€å·¥äº‹åï¼ˆå¿…é ˆï¼‰ã€å·¥äº‹æœŸé–“ãªã©ã‚’å…¥åŠ›ã—ã¾ã™</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-step-num">2</div>
                <div class="help-step-content">
                    <h5>åŸä¾¡ã‚’å…¥åŠ›</h5>
                    <p>ã€Œä¸­é …ç›®è¿½åŠ ã€ã§å·¥äº‹é …ç›®ã‚’è¿½åŠ ã—ã€æ•°é‡ãƒ»å˜ä¾¡ã‚’å…¥åŠ›ã—ã¾ã™</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-step-num">3</div>
                <div class="help-step-content">
                    <h5>çµŒè²»ã‚’ç¢ºèª</h5>
                    <p>å®‰å…¨å¯¾ç­–è²»ãƒ»è«¸çµŒè²»ãªã©ã®ç‡ã‚’ç¢ºèªãƒ»èª¿æ•´ã—ã¾ã™</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-step-num">4</div>
                <div class="help-step-content">
                    <h5>ç¢ºèªãƒ»æ‰¿èªç”³è«‹</h5>
                    <p>å†…å®¹ã‚’ç¢ºèªã—ã€æ‰¿èªè€…ã‚’é¸ã‚“ã§ç”³è«‹ã—ã¾ã™</p>
                </div>
            </div>
        </div>

        <div class="help-section">
            <h4>ğŸ’¡ æ“ä½œã®ãƒã‚¤ãƒ³ãƒˆ</h4>
            <div class="help-tip">
                <strong>ğŸ’¾ ã“ã¾ã‚ã«ä¿å­˜</strong><br>
                å…¥åŠ›ä¸­ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§éšæ™‚ä¿å­˜ã—ã¾ã—ã‚‡ã†ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
            </div>
            <div class="help-tip">
                <strong>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼</strong><br>
                åŸä¾¡å…¥åŠ›ç”»é¢ã®ã€Œã‚µãƒ³ãƒ—ãƒ«èª­è¾¼ã€ã§ã€å…¥åŠ›ä¾‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
            </div>
            <div class="help-tip">
                <strong>ğŸ”¢ é‡‘é¡ã¯è‡ªå‹•è¨ˆç®—</strong><br>
                æ•°é‡Ã—å˜ä¾¡ã¯è‡ªå‹•ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚çµŒè²»ã‚‚ç›´æ¥å·¥äº‹è²»ã‹ã‚‰è‡ªå‹•ç®—å‡ºã•ã‚Œã¾ã™ã€‚
            </div>
        </div>

        <div class="help-section">
            <h4>ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦</h4>
            <ul>
                <li><strong>ä½œæˆä¸­</strong>ï¼šç·¨é›†å¯èƒ½ãªçŠ¶æ…‹</li>
                <li><strong>æ‰¿èªå¾…ã¡</strong>ï¼šæ‰¿èªè€…ã®ç¢ºèªå¾…ã¡</li>
                <li><strong>æ‰¿èªæ¸ˆ</strong>ï¼šæ‰¿èªå®Œäº†</li>
                <li><strong>å´ä¸‹</strong>ï¼šå·®ã—æˆ»ã—ï¼ˆå†ç”³è«‹å¯èƒ½ï¼‰</li>
            </ul>
            <p style="margin-top:12px;">æ‰¿èªè€…ã«ã¯ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ãŒå±Šãã¾ã™ã€‚</p>
        </div>

        <div class="help-section">
            <h4>ğŸ”‘ ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
            <table style="width:100%;font-size:12px;border-collapse:collapse;">
                <tr style="background:#f7fafc;"><th style="padding:8px;text-align:left;">ç¤¾å“¡ç•ªå·</th><th style="padding:8px;">æ°å</th><th style="padding:8px;">æ¨©é™</th></tr>
                <tr><td style="padding:6px;border-bottom:1px solid #e2e8f0;">1001</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">å±±ç”°å¤ªéƒ</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ç®¡ç†è€…</td></tr>
                <tr><td style="padding:6px;border-bottom:1px solid #e2e8f0;">1002</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">éˆ´æœ¨ä¸€éƒ</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ä¸€èˆ¬</td></tr>
                <tr><td style="padding:6px;border-bottom:1px solid #e2e8f0;">1003</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ç”°ä¸­èŠ±å­</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ä¸€èˆ¬</td></tr>
                <tr><td style="padding:6px;border-bottom:1px solid #e2e8f0;">1004</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ä½è—¤æ¬¡éƒ</td><td style="padding:6px;border-bottom:1px solid #e2e8f0;">ä¸€èˆ¬</td></tr>
                <tr><td style="padding:6px;">1005</td><td style="padding:6px;">é«˜æ©‹ç¾å’²</td><td style="padding:6px;">ç®¡ç†è€…</td></tr>
            </table>
            <p style="margin-top:8px;font-size:12px;color:#718096;">â€»å…¨å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: 0001</p>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="userModalTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç¤¾å“¡ç•ªå· <span class="required">*</span></label>
                    <input type="text" class="form-control" id="userEmpId">
                </div>
                <div class="form-group">
                    <label>æ°å <span class="required">*</span></label>
                    <input type="text" class="form-control" id="userName">
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
                    <input type="email" class="form-control" id="userEmail">
                </div>
                <div class="form-group">
                    <label>æ¨©é™</label>
                    <select class="form-control" id="userRole">
                        <option value="user">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                        <option value="admin">ç®¡ç†è€…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ–°è¦ã®ã¿ï¼‰</label>
                    <input type="password" class="form-control" id="userPassword" value="0001">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('userModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="customerModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h3 id="customerModalTitle">é¡§å®¢è¿½åŠ </h3>
                <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>é¡§å®¢ã‚³ãƒ¼ãƒ‰ <span class="required">*</span></label>
                        <input type="text" class="form-control" id="custCode" placeholder="ä¾‹: C006">
                    </div>
                    <div class="form-group">
                        <label>é¡§å®¢å <span class="required">*</span></label>
                        <input type="text" class="form-control" id="custName" placeholder="ä¾‹: â—‹â—‹æ ªå¼ä¼šç¤¾">
                    </div>
                    <div class="form-group full-width">
                        <label>ãƒ•ãƒªã‚¬ãƒŠ</label>
                        <input type="text" class="form-control" id="custKana" placeholder="ä¾‹: ãƒãƒ«ãƒãƒ«ã‚«ãƒ–ã‚·ã‚­ã‚¬ã‚¤ã‚·ãƒ£">
                    </div>
                    <div class="form-group">
                        <label>éƒµä¾¿ç•ªå·</label>
                        <input type="text" class="form-control" id="custZip" placeholder="ä¾‹: 100-0001">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="text" class="form-control" id="custTel" placeholder="ä¾‹: 03-1234-5678">
                    </div>
                    <div class="form-group full-width">
                        <label>ä½æ‰€</label>
                        <input type="text" class="form-control" id="custAddress" placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒº...">
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" class="form-control" id="custEmail" placeholder="ä¾‹: info@example.co.jp">
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“è€…</label>
                        <input type="text" class="form-control" id="custContact" placeholder="ä¾‹: å–¶æ¥­éƒ¨ å±±ç”°æ§˜">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('customerModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveCustomer()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ‰¿èªç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="approvalModal">
        <div class="modal">
            <div class="modal-header">
                <h3>æ‰¿èªç”³è«‹</h3>
                <button class="modal-close" onclick="closeModal('approvalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ‰¿èªè€…ã‚’é¸æŠ <span class="required">*</span></label>
                    <select class="form-control" id="approverSelect"></select>
                </div>
                <div class="form-group">
                    <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
                    <textarea class="form-control" id="approvalComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('approvalModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="submitApproval()">ç”³è«‹ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- æ‰¿èª/å´ä¸‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="reviewModalTitle">æ‰¿èªç¢ºèª</h3>
                <button class="modal-close" onclick="closeModal('reviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="reviewModalMessage"></p>
                <div class="form-group" style="margin-top:16px;">
                    <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
                    <textarea class="form-control" id="reviewComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('reviewModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" id="reviewConfirmBtn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // ===== Supabaseè¨­å®š =====
        // â˜…â˜…â˜… ä»¥ä¸‹ã®2ã¤ã‚’è‡ªåˆ†ã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„ â˜…â˜…â˜…
        const SUPABASE_URL = 'https://ndwbhcmhzpcvktksdcoy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kd2JoY21oenBjdmt0a3NkY295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTUwOTcsImV4cCI6MjA4NTU5MTA5N30.2GGpCETycqNrR7wsv7dTve2K93dMx1lLtWKiDIeqGYY';

        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== ãƒ‡ãƒ¼ã‚¿ =====
        let users = [];
        let customers = [];
        let estimates = [];
        let notifications = [];
        let currentUser = null;
        let currentEstimateId = null;
        let categories = [];
        let categoryId = 0;
        let currentFilter = '';
        let editingUserId = null;
        let editingCustomerId = null;
        let isLoading = false;

        const officeData = {
            'æœ¬ç¤¾': { zip: '135-0023', address: 'æ±äº¬éƒ½æ±Ÿæ±åŒºå¹³é‡3-2-6', tel: '03-3630-5555' },
            'åƒè‘‰äº‹å‹™æ‰€': { zip: '290-0067', address: 'åƒè‘‰çœŒå¸‚åŸå¸‚å…«å¹¡æµ·å²¸é€š1969-52', tel: '0436-26-4020' },
            'äº¬æµœäº‹å‹™æ‰€': { zip: '210-0814', address: 'ç¥å¥ˆå·çœŒå·å´å¸‚å·å´åŒºå°ç”º13-10', tel: '044-280-6391' },
            'è¥¿æ—¥æœ¬äº‹å‹™æ‰€': { zip: '721-0963', address: 'åºƒå³¶çœŒç¦å±±å¸‚å—æ‰‹åŸç”º2-13-28', tel: '084-973-9437' },
            'ä¹å·äº‹å‹™æ‰€': { zip: '802-0013', address: 'ç¦å²¡çœŒåŒ—ä¹å·å¸‚å°å€‰åŒ—åŒºé•·æµœç”º10-7', tel: '093-953-8815' }
        };

        const statusLabels = {
            'draft': { label: 'ä½œæˆä¸­', class: 'status-draft' },
            'pending': { label: 'æ‰¿èªå¾…ã¡', class: 'status-pending' },
            'approved': { label: 'æ‰¿èªæ¸ˆ', class: 'status-approved' },
            'rejected': { label: 'å´ä¸‹', class: 'status-rejected' }
        };

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Supabaseæ¥ç¶šç¢ºèª
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                alert('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚\\nindex.htmlã®SUPABASE_URLã¨SUPABASE_ANON_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            await loadFromSupabase();
            initPeriodSelects();
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒï¼ˆF5å¯¾å¿œï¼‰
            await restoreSession();
        });

        async function restoreSession() {
            const savedUser = sessionStorage.getItem('besterra_currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = users.find(u => u.emp_id === userData.empId);
                if (user) {
                    currentUser = { empId: user.emp_id, name: user.name, email: user.email, role: user.role, password: user.password };
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').classList.add('active');
                    document.getElementById('currentUserName').textContent = user.name;
                    document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼';

                    if (user.role === 'admin') {
                        document.getElementById('navUsers').style.display = 'flex';
                        document.getElementById('navCustomers').style.display = 'flex';
                    }

                    updateDashboard();
                    updateBadges();
                }
            }
        }

        // ===== Supabaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
        async function loadFromSupabase() {
            try {
                showLoading(true);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿
                const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                if (usersError) throw usersError;
                users = usersData || [];

                // é¡§å®¢èª­ã¿è¾¼ã¿
                const { data: customersData, error: customersError } = await supabase.from('customers').select('*');
                if (customersError) throw customersError;
                customers = customersData || [];

                // è¦‹ç©èª­ã¿è¾¼ã¿
                const { data: estimatesData, error: estimatesError } = await supabase.from('estimates').select('*').order('created_at', { ascending: false });
                if (estimatesError) throw estimatesError;
                estimates = (estimatesData || []).map(e => ({
                    id: e.id,
                    basic: {
                        customerId: e.customer_id,
                        customerName: e.customer_name,
                        projectName: e.project_name,
                        quoteDate: e.quote_date,
                        siteAddress: e.site_address,
                        periodStart: e.period_start,
                        periodEnd: e.period_end,
                        office: e.office
                    },
                    status: e.status,
                    total: e.total,
                    categories: e.categories || [],
                    expenses: e.expenses || {},
                    creatorId: e.creator_id,
                    approverId: e.approver_id,
                    createdAt: e.created_at?.split('T')[0],
                    updatedAt: e.updated_at?.split('T')[0],
                    submittedAt: e.submitted_at?.split('T')[0],
                    approvedAt: e.approved_at?.split('T')[0]
                }));

                // é€šçŸ¥èª­ã¿è¾¼ã¿
                const { data: notificationsData, error: notificationsError } = await supabase.from('notifications').select('*').order('created_at', { ascending: false });
                if (notificationsError) throw notificationsError;
                notifications = (notificationsData || []).map(n => ({
                    id: n.id,
                    userId: n.user_id,
                    type: n.type,
                    title: n.title,
                    message: n.message,
                    estimateId: n.estimate_id,
                    read: n.read,
                    createdAt: n.created_at
                }));

                console.log('Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                showLoading(false);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showLoading(false);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function showLoading(show) {
            isLoading = show;
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
        }

        // äº’æ›æ€§ã®ãŸã‚ã®é–¢æ•°ï¼ˆä½¿ç”¨ã—ãªã„ï¼‰
        function saveToLocalStorage() {
            // Supabaseç‰ˆã§ã¯ä½¿ç”¨ã—ãªã„
        }

        function createSampleEstimates() {
            // Supabaseç‰ˆã§ã¯SQLã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„
        }

        // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
        function login() {
            const empId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            // Supabaseã®ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ï¼ˆemp_idï¼‰ã«å¯¾å¿œ
            const user = users.find(u => u.emp_id === empId && u.password === password);

            if (user) {
                currentUser = { empId: user.emp_id, name: user.name, email: user.email, role: user.role, password: user.password };
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆF5å¯¾å¿œï¼‰
                sessionStorage.setItem('besterra_currentUser', JSON.stringify({ empId: user.emp_id }));

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼';

                if (user.role === 'admin') {
                    document.getElementById('navUsers').style.display = 'flex';
                    document.getElementById('navCustomers').style.display = 'flex';
                }

                updateDashboard();
                updateBadges();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            sessionStorage.removeItem('besterra_currentUser');

            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('navUsers').style.display = 'none';
            document.getElementById('navCustomers').style.display = 'none';
        }

        // ===== ãƒšãƒ¼ã‚¸ =====
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');

            const navMap = { 'dashboard': 0, 'list': 1, 'approvals': 3, 'notifications': 4 };
            if (navMap[pageName] !== undefined) {
                document.querySelectorAll('.nav-item')[navMap[pageName]].classList.add('active');
            }

            if (pageName === 'dashboard') updateDashboard();
            else if (pageName === 'list') renderEstimateList();
            else if (pageName === 'approvals') renderApprovalList();
            else if (pageName === 'notifications') renderNotifications();
            else if (pageName === 'users') renderUserList();
            else if (pageName === 'customers') renderCustomerList();
        }

        // ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
        function updateDashboard() {
            const myEstimates = estimates.filter(e => e.creatorId === currentUser.empId);
            document.getElementById('stat-draft').textContent = myEstimates.filter(e => e.status === 'draft').length;
            document.getElementById('stat-pending').textContent = myEstimates.filter(e => e.status === 'pending').length;
            document.getElementById('stat-approved').textContent = myEstimates.filter(e => e.status === 'approved').length;
            document.getElementById('stat-total').textContent = formatCurrency(myEstimates.reduce((s, e) => s + (e.total || 0), 0));

            const tbody = document.getElementById('recent-estimates');
            tbody.innerHTML = estimates.slice(0, 5).map(e => {
                const creator = users.find(u => u.emp_id === e.creatorId);
                return `
                    <tr class="clickable" onclick="editEstimate(${e.id})">
                        <td>${e.basic.projectName || '-'}</td>
                        <td>${e.basic.customerName || '-'}</td>
                        <td style="text-align:right;font-weight:bold;">${formatCurrency(e.total || 0)}</td>
                        <td><span class="status-badge ${statusLabels[e.status].class}">${statusLabels[e.status].label}</span></td>
                        <td>${creator ? creator.name : '-'}</td>
                        <td>${e.updatedAt || ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateBadges() {
            const pendingApprovals = estimates.filter(e => e.status === 'pending' && e.approverId === currentUser.empId).length;
            const unreadNotifications = notifications.filter(n => n.userId === currentUser.empId && !n.read).length;

            const approvalBadge = document.getElementById('approvalBadge');
            const notificationBadge = document.getElementById('notificationBadge');

            if (pendingApprovals > 0) {
                approvalBadge.textContent = pendingApprovals;
                approvalBadge.style.display = 'inline';
            } else {
                approvalBadge.style.display = 'none';
            }

            if (unreadNotifications > 0) {
                notificationBadge.textContent = unreadNotifications;
                notificationBadge.style.display = 'inline';
            } else {
                notificationBadge.style.display = 'none';
            }
        }

        // ===== è¦‹ç©ä¸€è¦§ =====
        function renderEstimateList() {
            let filtered = estimates;
            if (currentFilter) filtered = estimates.filter(e => e.status === currentFilter);

            const tbody = document.getElementById('all-estimates');
            tbody.innerHTML = filtered.map(e => {
                const creator = users.find(u => u.emp_id === e.creatorId);
                const approver = users.find(u => u.emp_id === e.approverId);
                return `
                    <tr class="clickable" onclick="editEstimate(${e.id})">
                        <td>${e.basic.projectName || '-'}</td>
                        <td>${e.basic.customerName || '-'}</td>
                        <td style="text-align:right;font-weight:bold;">${formatCurrency(e.total || 0)}</td>
                        <td><span class="status-badge ${statusLabels[e.status].class}">${statusLabels[e.status].label}</span></td>
                        <td>${creator ? creator.name : '-'}</td>
                        <td>${approver ? approver.name : '-'}</td>
                        <td>${e.updatedAt || ''}</td>
                        <td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation();deleteEstimate(${e.id})">å‰Šé™¤</button></td>
                    </tr>
                `;
            }).join('');
        }

        function filterByStatus(status) { currentFilter = status; renderEstimateList(); }
        function filterEstimates() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = estimates.filter(e =>
                (e.basic.projectName || '').toLowerCase().includes(q) ||
                (e.basic.customerName || '').toLowerCase().includes(q)
            );
            const tbody = document.getElementById('all-estimates');
            tbody.innerHTML = filtered.map(e => {
                const creator = users.find(u => u.emp_id === e.creatorId);
                return `<tr class="clickable" onclick="editEstimate(${e.id})">
                    <td>${e.basic.projectName || '-'}</td><td>${e.basic.customerName || '-'}</td>
                    <td style="text-align:right;">${formatCurrency(e.total||0)}</td>
                    <td><span class="status-badge ${statusLabels[e.status].class}">${statusLabels[e.status].label}</span></td>
                    <td>${creator?creator.name:'-'}</td><td>-</td><td>${e.updatedAt||''}</td><td></td>
                </tr>`;
            }).join('');
        }

        // ===== æ–°è¦ä½œæˆãƒ»ç·¨é›† =====
        async function createNewEstimate() {
            const today = new Date().toISOString().split('T')[0];

            try {
                const { data, error } = await supabase.from('estimates').insert({
                    customer_name: '',
                    project_name: 'æ–°è¦è¦‹ç©',
                    quote_date: today,
                    site_address: '',
                    office: '',
                    status: 'draft',
                    total: 0,
                    categories: [],
                    expenses: { safetyRate: 2, overheadRate: 15, laborRate: 24 },
                    creator_id: currentUser.empId
                }).select().single();

                if (error) throw error;

                // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã«è¿½åŠ 
                estimates.unshift({
                    id: data.id,
                    basic: { customerName: '', projectName: 'æ–°è¦è¦‹ç©', quoteDate: today, siteAddress: '', office: '', periodStart: '', periodEnd: '' },
                    status: 'draft',
                    total: 0,
                    categories: [],
                    expenses: { safetyRate: 2, overheadRate: 15, laborRate: 24 },
                    creatorId: currentUser.empId,
                    approverId: null,
                    createdAt: today,
                    updatedAt: today
                });

                editEstimate(data.id);
            } catch (error) {
                console.error('è¦‹ç©ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('è¦‹ç©ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function editEstimate(id) {
            currentEstimateId = id;
            const e = estimates.find(x => x.id === id);
            if (!e) return;

            document.getElementById('edit-page-title').textContent = e.basic.projectName || 'æ–°è¦è¦‹ç©';

            // é¡§å®¢ã‚»ãƒ¬ã‚¯ãƒˆã‚’è¨­å®š
            populateCustomerSelect();
            const custSel = document.getElementById('customerSelect');
            if (e.basic.customerId) {
                custSel.value = e.basic.customerId;
            } else if (e.basic.customerName) {
                // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›: é¡§å®¢åã‹ã‚‰é¡§å®¢ã‚’æ¤œç´¢
                const foundCust = customers.find(c => c.name === e.basic.customerName);
                custSel.value = foundCust ? foundCust.id : '';
            } else {
                custSel.value = '';
            }
            updateCustomerInfo();

            document.getElementById('quoteDate').value = e.basic.quoteDate || '';
            document.getElementById('projectName').value = e.basic.projectName || '';
            document.getElementById('siteAddress').value = e.basic.siteAddress || '';
            setPeriodValue('periodStart', e.basic.periodStart || '');
            setPeriodValue('periodEnd', e.basic.periodEnd || '');
            document.getElementById('office').value = e.basic.office || '';
            updateOfficeInfo();

            categories = e.categories || [];
            categoryId = categories.length > 0 ? Math.max(...categories.map(c => c.id)) : 0;
            renderCategories();

            if (e.expenses) {
                document.getElementById('safetyRate').value = e.expenses.safetyRate || 2;
                document.getElementById('overheadRate').value = e.expenses.overheadRate || 15;
                document.getElementById('laborRate').value = e.expenses.laborRate || 24;
            }

            calculateExpenses();
            updateWorkflowDisplay(e);
            showPage('edit');
            showEditTab('basic');
        }

        async function saveCurrentEstimate() {
            if (!currentEstimateId) return;
            const e = estimates.find(x => x.id === currentEstimateId);
            if (!e) return;

            const updatedBasic = {
                customerId: parseInt(document.getElementById('customerSelect').value) || null,
                customerName: getCustomerName(),
                quoteDate: document.getElementById('quoteDate').value,
                projectName: document.getElementById('projectName').value,
                siteAddress: document.getElementById('siteAddress').value,
                periodStart: getPeriodValue('periodStart'),
                periodEnd: getPeriodValue('periodEnd'),
                office: document.getElementById('office').value
            };
            const updatedExpenses = {
                safetyRate: parseFloat(document.getElementById('safetyRate').value),
                overheadRate: parseFloat(document.getElementById('overheadRate').value),
                laborRate: parseFloat(document.getElementById('laborRate').value)
            };
            const total = calculateTotalAmount();

            try {
                const { error } = await supabase.from('estimates').update({
                    customer_id: updatedBasic.customerId,
                    customer_name: updatedBasic.customerName,
                    project_name: updatedBasic.projectName,
                    quote_date: updatedBasic.quoteDate || null,
                    site_address: updatedBasic.siteAddress,
                    period_start: updatedBasic.periodStart || null,
                    period_end: updatedBasic.periodEnd || null,
                    office: updatedBasic.office,
                    categories: categories,
                    expenses: updatedExpenses,
                    total: total,
                    updated_at: new Date().toISOString()
                }).eq('id', currentEstimateId);

                if (error) throw error;

                // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‚‚æ›´æ–°
                e.basic = updatedBasic;
                e.categories = categories;
                e.expenses = updatedExpenses;
                e.total = total;
                e.updatedAt = new Date().toISOString().split('T')[0];

                alert('ä¿å­˜ã—ã¾ã—ãŸ');
                document.getElementById('edit-page-title').textContent = e.basic.projectName || 'æ–°è¦è¦‹ç©';
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteEstimate(id) {
            if (confirm('ã“ã®è¦‹ç©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const { error } = await supabase.from('estimates').delete().eq('id', id);
                    if (error) throw error;

                    estimates = estimates.filter(e => e.id !== id);

                    // ç·¨é›†ä¸­ã®è¦‹ç©ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯ä¸€è¦§ã«æˆ»ã‚‹
                    if (currentEstimateId === id) {
                        currentEstimateId = null;
                    }

                    // å³æ™‚UIæ›´æ–°
                    showPage('list');
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }

        // ===== ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ =====
        function updateWorkflowDisplay(e) {
            const creator = users.find(u => u.emp_id === e.creatorId);
            const approver = users.find(u => u.emp_id === e.approverId);
            const isCreator = currentUser.empId === e.creatorId;
            const isApprover = currentUser.empId === e.approverId;

            let statusHtml = '';
            let actionsHtml = '';

            if (e.status === 'draft') {
                statusHtml = `
                    <div class="workflow-step"><div class="circle current">1</div><span>${creator ? creator.name : 'ç”³è«‹è€…'}</span></div>
                    <div class="workflow-arrow">â†’</div>
                    <div class="workflow-step"><div class="circle pending">2</div><span>æ‰¿èªè€…</span></div>
                `;
                if (isCreator) {
                    actionsHtml = `<button class="btn btn-warning" onclick="openApprovalModal()">ğŸ“¤ æ‰¿èªç”³è«‹</button>`;
                }
            } else if (e.status === 'pending') {
                statusHtml = `
                    <div class="workflow-step"><div class="circle done">âœ“</div><span>${creator ? creator.name : 'ç”³è«‹è€…'}</span></div>
                    <div class="workflow-arrow">â†’</div>
                    <div class="workflow-step"><div class="circle current">2</div><span>${approver ? approver.name : 'æ‰¿èªè€…'}</span></div>
                `;
                if (isApprover) {
                    actionsHtml = `
                        <button class="btn btn-success" onclick="openReviewModal('approve')">âœ… æ‰¿èª</button>
                        <button class="btn btn-danger" onclick="openReviewModal('reject')">âŒ å´ä¸‹</button>
                    `;
                } else if (isCreator) {
                    actionsHtml = `<button class="btn btn-outline" onclick="withdrawApproval()">å–ä¸‹ã’</button>`;
                }
            } else if (e.status === 'approved') {
                statusHtml = `
                    <div class="workflow-step"><div class="circle done">âœ“</div><span>${creator ? creator.name : 'ç”³è«‹è€…'}</span></div>
                    <div class="workflow-arrow">â†’</div>
                    <div class="workflow-step"><div class="circle done">âœ“</div><span>${approver ? approver.name : 'æ‰¿èªè€…'}</span></div>
                `;
                actionsHtml = `<span style="color:#38a169;font-weight:bold;">âœ… æ‰¿èªæ¸ˆã¿ï¼ˆ${e.approvedAt}ï¼‰</span>`;
            } else if (e.status === 'rejected') {
                statusHtml = `
                    <div class="workflow-step"><div class="circle done">âœ“</div><span>${creator ? creator.name : 'ç”³è«‹è€…'}</span></div>
                    <div class="workflow-arrow">â†’</div>
                    <div class="workflow-step"><div class="circle rejected">âœ—</div><span>${approver ? approver.name : 'æ‰¿èªè€…'}</span></div>
                `;
                actionsHtml = `<span style="color:#e53e3e;font-weight:bold;">âŒ å´ä¸‹ã•ã‚Œã¾ã—ãŸ</span>`;
                if (isCreator) {
                    actionsHtml += `<button class="btn btn-outline" style="margin-left:12px;" onclick="resubmit()">å†ç”³è«‹</button>`;
                }
            }

            document.getElementById('workflowStatus').innerHTML = statusHtml;
            document.getElementById('workflowActions').innerHTML = actionsHtml;
        }

        function openApprovalModal() {
            const select = document.getElementById('approverSelect');
            select.innerHTML = users.filter(u => u.emp_id !== currentUser.empId).map(u =>
                `<option value="${u.emp_id}">${u.name}ï¼ˆ${u.emp_id}ï¼‰</option>`
            ).join('');
            document.getElementById('approvalComment').value = '';
            document.getElementById('approvalModal').classList.add('active');
        }

        function submitApproval() {
            const approverId = document.getElementById('approverSelect').value;
            const comment = document.getElementById('approvalComment').value;
            const e = estimates.find(x => x.id === currentEstimateId);
            if (!e) return;

            e.status = 'pending';
            e.approverId = approverId;
            e.submittedAt = new Date().toISOString().split('T')[0];
            e.updatedAt = e.submittedAt;

            // æ‰¿èªè€…ã«é€šçŸ¥
            const approver = users.find(u => u.emp_id === approverId);
            addNotification(approverId, 'request', `${currentUser.name}ã•ã‚“ã‹ã‚‰æ‰¿èªä¾é ¼`, `ã€Œ${e.basic.projectName}ã€ã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`, e.id);

            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            console.log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${approver.email} ã¸æ‰¿èªä¾é ¼é€šçŸ¥`);
            alert(`æ‰¿èªç”³è«‹ã—ã¾ã—ãŸã€‚\n\nğŸ“§ ${approver.name}ã•ã‚“ï¼ˆ${approver.email}ï¼‰ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);

            saveToLocalStorage();
            closeModal('approvalModal');
            updateWorkflowDisplay(e);
            updateBadges();
        }

        function openReviewModal(action) {
            const e = estimates.find(x => x.id === currentEstimateId);
            const title = action === 'approve' ? 'æ‰¿èªç¢ºèª' : 'å´ä¸‹ç¢ºèª';
            const message = action === 'approve'
                ? `ã€Œ${e.basic.projectName}ã€ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`
                : `ã€Œ${e.basic.projectName}ã€ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ`;

            document.getElementById('reviewModalTitle').textContent = title;
            document.getElementById('reviewModalMessage').textContent = message;
            document.getElementById('reviewComment').value = '';
            document.getElementById('reviewConfirmBtn').onclick = () => processReview(action);
            document.getElementById('reviewConfirmBtn').className = action === 'approve' ? 'btn btn-success' : 'btn btn-danger';
            document.getElementById('reviewConfirmBtn').textContent = action === 'approve' ? 'æ‰¿èªã™ã‚‹' : 'å´ä¸‹ã™ã‚‹';
            document.getElementById('reviewModal').classList.add('active');
        }

        function processReview(action) {
            const e = estimates.find(x => x.id === currentEstimateId);
            if (!e) return;

            const today = new Date().toISOString().split('T')[0];
            const creator = users.find(u => u.emp_id === e.creatorId);

            if (action === 'approve') {
                e.status = 'approved';
                e.approvedAt = today;
                addNotification(e.creatorId, 'approval', 'æ‰¿èªã•ã‚Œã¾ã—ãŸ', `ã€Œ${e.basic.projectName}ã€ãŒ${currentUser.name}ã•ã‚“ã«æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚`, e.id);
                console.log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${creator.email} ã¸æ‰¿èªé€šçŸ¥`);
                alert(`æ‰¿èªã—ã¾ã—ãŸã€‚\n\nğŸ“§ ${creator.name}ã•ã‚“ï¼ˆ${creator.email}ï¼‰ã«æ‰¿èªé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
            } else {
                e.status = 'rejected';
                e.rejectedAt = today;
                addNotification(e.creatorId, 'reject', 'å´ä¸‹ã•ã‚Œã¾ã—ãŸ', `ã€Œ${e.basic.projectName}ã€ãŒ${currentUser.name}ã•ã‚“ã«å´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚`, e.id);
                console.log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${creator.email} ã¸å´ä¸‹é€šçŸ¥`);
                alert(`å´ä¸‹ã—ã¾ã—ãŸã€‚\n\nğŸ“§ ${creator.name}ã•ã‚“ï¼ˆ${creator.email}ï¼‰ã«å´ä¸‹é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
            }

            e.updatedAt = today;
            saveToLocalStorage();
            closeModal('reviewModal');
            updateWorkflowDisplay(e);
            updateBadges();
        }

        function withdrawApproval() {
            if (!confirm('æ‰¿èªç”³è«‹ã‚’å–ã‚Šä¸‹ã’ã¾ã™ã‹ï¼Ÿ')) return;
            const e = estimates.find(x => x.id === currentEstimateId);
            if (!e) return;

            e.status = 'draft';
            e.approverId = null;
            e.updatedAt = new Date().toISOString().split('T')[0];
            saveToLocalStorage();
            updateWorkflowDisplay(e);
            updateBadges();
            alert('å–ã‚Šä¸‹ã’ã¾ã—ãŸ');
        }

        function resubmit() {
            const e = estimates.find(x => x.id === currentEstimateId);
            if (!e) return;
            e.status = 'draft';
            e.approverId = null;
            saveToLocalStorage();
            updateWorkflowDisplay(e);
        }

        // ===== æ‰¿èªä¾é ¼ä¸€è¦§ =====
        function renderApprovalList() {
            const pending = estimates.filter(e => e.status === 'pending' && e.approverId === currentUser.empId);
            const tbody = document.getElementById('approval-list');
            tbody.innerHTML = pending.map(e => {
                const creator = users.find(u => u.emp_id === e.creatorId);
                return `
                    <tr>
                        <td>${e.basic.projectName || '-'}</td>
                        <td>${e.basic.customerName || '-'}</td>
                        <td style="text-align:right;font-weight:bold;">${formatCurrency(e.total || 0)}</td>
                        <td>${creator ? creator.name : '-'}</td>
                        <td>${e.submittedAt || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editEstimate(${e.id})">ç¢ºèª</button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (pending.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#718096;">æ‰¿èªä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
            }
        }

        // ===== é€šçŸ¥ =====
        async function addNotification(userId, type, title, message, estimateId) {
            try {
                const { data, error } = await supabase.from('notifications').insert({
                    user_id: userId,
                    type: type,
                    title: title,
                    message: message,
                    estimate_id: estimateId,
                    read: false
                }).select().single();

                if (error) throw error;

                notifications.unshift({
                    id: data.id,
                    userId: userId,
                    type: type,
                    title: title,
                    message: message,
                    estimateId: estimateId,
                    read: false,
                    createdAt: data.created_at
                });
            } catch (error) {
                console.error('é€šçŸ¥ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderNotifications() {
            const myNotifications = notifications.filter(n => n.userId === currentUser.empId);
            const list = document.getElementById('notification-list');
            list.innerHTML = myNotifications.map(n => {
                const iconClass = n.type === 'approval' ? 'approval' : n.type === 'request' ? 'request' : 'reject';
                const icon = n.type === 'approval' ? 'âœ…' : n.type === 'request' ? 'ğŸ“¤' : 'âŒ';
                const time = new Date(n.createdAt).toLocaleString('ja-JP');
                return `
                    <div class="notification-item ${n.read ? '' : 'unread'}" onclick="readNotification(${n.id}, ${n.estimateId})">
                        <div class="icon ${iconClass}">${icon}</div>
                        <div class="content">
                            <h5>${n.title}</h5>
                            <p>${n.message}</p>
                        </div>
                        <div class="time">${time}</div>
                    </div>
                `;
            }).join('');

            if (myNotifications.length === 0) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#718096;">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            }
        }

        function readNotification(notifId, estimateId) {
            const n = notifications.find(x => x.id === notifId);
            if (n) n.read = true;
            saveToLocalStorage();
            updateBadges();
            if (estimateId) editEstimate(estimateId);
        }

        function markAllRead() {
            notifications.filter(n => n.userId === currentUser.empId).forEach(n => n.read = true);
            saveToLocalStorage();
            updateBadges();
            renderNotifications();
        }

        // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† =====
        function renderUserList() {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.emp_id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="openUserModal('${u.emp_id}')">ç·¨é›†</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.emp_id}')">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function openUserModal(empId = null) {
            editingUserId = empId;
            if (empId) {
                const u = users.find(x => x.empId === empId);
                document.getElementById('userModalTitle').textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†';
                document.getElementById('userEmpId').value = u.emp_id;
                document.getElementById('userEmpId').disabled = true;
                document.getElementById('userName').value = u.name;
                document.getElementById('userEmail').value = u.email;
                document.getElementById('userRole').value = u.role;
                document.getElementById('userPassword').value = '';
            } else {
                document.getElementById('userModalTitle').textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ';
                document.getElementById('userEmpId').value = '';
                document.getElementById('userEmpId').disabled = false;
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userRole').value = 'user';
                document.getElementById('userPassword').value = '0001';
            }
            document.getElementById('userModal').classList.add('active');
        }

        function saveUser() {
            const empId = document.getElementById('userEmpId').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;

            if (!empId || !name || !email) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (editingUserId) {
                const u = users.find(x => x.empId === editingUserId);
                u.name = name;
                u.email = email;
                u.role = role;
                if (password) u.password = password;
            } else {
                if (users.find(u => u.emp_id === empId)) {
                    alert('ã“ã®ç¤¾å“¡ç•ªå·ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
                    return;
                }
                users.push({ empId, name, email, role, password: password || '0001' });
            }

            saveToLocalStorage();
            closeModal('userModal');
            renderUserList();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function deleteUser(empId) {
            if (empId === currentUser.empId) {
                alert('è‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                return;
            }
            if (confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                users = users.filter(u => u.emp_id !== empId);
                saveToLocalStorage();
                renderUserList();
            }
        }

        // ===== ã‚¿ãƒ–ãƒ»ãƒ•ã‚©ãƒ¼ãƒ  =====
        function showEditTab(tabName) {
            document.querySelectorAll('#page-edit .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#page-edit .tab-panel').forEach(p => p.classList.remove('active'));
            const tabs = ['basic', 'cost', 'expense', 'output'];
            document.querySelectorAll('#page-edit .tab')[tabs.indexOf(tabName)].classList.add('active');
            document.getElementById('edit-' + tabName).classList.add('active');
            if (tabName === 'expense' || tabName === 'output') { calculateExpenses(); updatePreview(); }
            updateStepGuide(tabName);
        }

        function updateOfficeInfo() {
            const office = document.getElementById('office').value;
            const info = officeData[office];
            document.getElementById('officeInfo').innerHTML = info ? `ã€’${info.zip} ${info.address}<br>TEL: ${info.tel}` : '-';
        }

        // ===== åŸä¾¡å…¥åŠ› =====
        function addCategory(name = '') {
            categoryId++;
            categories.push({ id: categoryId, name: name || `å·¥äº‹é …ç›®${categoryId}`, items: [
                { no: 1, name: '', spec: '', qty: '', unit: '', price: '', note: '' },
                { no: 2, name: '', spec: '', qty: '', unit: '', price: '', note: '' },
                { no: 3, name: '', spec: '', qty: '', unit: '', price: '', note: '' }
            ]});
            renderCategories();
        }

        function renderCategories() {
            const container = document.getElementById('costCategories');
            container.innerHTML = categories.map((cat, idx) => {
                const subtotal = cat.items.reduce((s, i) => s + ((parseFloat(i.qty)||0)*(parseFloat(i.price)||0)), 0);
                return `
                    <div class="category-header" onclick="toggleCategory(${cat.id})">
                        <h4><span>â–¼</span> ${idx+1}) <input type="text" value="${cat.name}" onclick="event.stopPropagation()" onchange="updateCategoryName(${cat.id},this.value)" style="background:transparent;border:none;color:white;font-size:14px;font-weight:bold;width:160px;"></h4>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-weight:bold;">${formatCurrency(subtotal)}</span>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteCategory(${cat.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="category-content" id="content-${cat.id}">
                        <table class="spreadsheet">
                            <thead><tr><th style="width:40px;">No</th><th style="width:160px;">åç§°</th><th style="width:100px;">å“ç¨®ãƒ»å¯¸æ³•</th><th style="width:60px;">æ•°é‡</th><th style="width:50px;">å˜ä½</th><th style="width:80px;">å˜ä¾¡</th><th style="width:90px;">é‡‘é¡</th><th>å‚™è€ƒ</th></tr></thead>
                            <tbody>
                                ${cat.items.map((item, i) => `
                                    <tr>
                                        <td class="col-no">${item.no}</td>
                                        <td><input type="text" value="${item.name}" onchange="updateItem(${cat.id},${i},'name',this.value)"></td>
                                        <td><input type="text" value="${item.spec}" onchange="updateItem(${cat.id},${i},'spec',this.value)"></td>
                                        <td><input type="number" value="${item.qty}" onchange="updateItem(${cat.id},${i},'qty',this.value)"></td>
                                        <td><input type="text" value="${item.unit}" onchange="updateItem(${cat.id},${i},'unit',this.value)" style="text-align:center;"></td>
                                        <td><input type="number" value="${item.price}" onchange="updateItem(${cat.id},${i},'price',this.value)"></td>
                                        <td class="col-amount"><input type="text" value="${formatNumber((parseFloat(item.qty)||0)*(parseFloat(item.price)||0))}" readonly></td>
                                        <td><input type="text" value="${item.note}" onchange="updateItem(${cat.id},${i},'note',this.value)"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="padding:8px 16px;background:#f7fafc;">
                            <button class="btn btn-sm btn-outline" onclick="addRow(${cat.id})">â• è¡Œè¿½åŠ </button>
                        </div>
                    </div>
                `;
            }).join('');
            updateCostSummary();
        }

        function toggleCategory(id) { document.getElementById('content-'+id).classList.toggle('collapsed'); }
        function updateCategoryName(id, name) { const c = categories.find(x=>x.id===id); if(c) c.name=name; }
        function deleteCategory(id) { categories = categories.filter(c=>c.id!==id); renderCategories(); }
        function addRow(catId) { const c = categories.find(x=>x.id===catId); if(c) { c.items.push({no:c.items.length+1,name:'',spec:'',qty:'',unit:'',price:'',note:''}); renderCategories(); }}
        function updateItem(catId,idx,field,val) { const c=categories.find(x=>x.id===catId); if(c&&c.items[idx]){c.items[idx][field]=val; renderCategories();}}
        function updateCostSummary() {
            const total = categories.reduce((s,c) => s + c.items.reduce((ss,i) => ss+((parseFloat(i.qty)||0)*(parseFloat(i.price)||0)),0),0);
            document.getElementById('totalDirectCost').textContent = formatCurrency(total);
            document.getElementById('categoryCount').textContent = categories.length;
            document.getElementById('itemCount').textContent = categories.reduce((s,c)=>s+c.items.filter(i=>i.name).length,0);
        }

        // ===== çµŒè²»è¨ˆç®— =====
        function calculateExpenses() {
            const dc = categories.reduce((s,c)=>s+c.items.reduce((ss,i)=>ss+((parseFloat(i.qty)||0)*(parseFloat(i.price)||0)),0),0);
            const sr = parseFloat(document.getElementById('safetyRate').value)/100||0;
            const or = parseFloat(document.getElementById('overheadRate').value)/100||0;
            const lr = parseFloat(document.getElementById('laborRate').value)/100||0;
            const safety = dc*sr, overhead = dc*or;
            const temp = dc+safety+overhead;
            const ins = temp*0.24*15/1000, welfare = temp*lr*0.161;
            const total = dc+safety+overhead+ins+welfare;
            document.getElementById('expDirectCost').textContent = formatCurrency(dc);
            document.getElementById('expSafety').textContent = formatCurrency(safety);
            document.getElementById('expOverhead').textContent = formatCurrency(overhead);
            document.getElementById('expInsurance').textContent = formatCurrency(ins);
            document.getElementById('expWelfare').textContent = formatCurrency(welfare);
            document.getElementById('expTotal').textContent = formatCurrency(total);
            return total;
        }
        function calculateTotalAmount() { return calculateExpenses(); }

        // ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
        function updatePreview() {
            document.getElementById('previewDate').textContent = document.getElementById('quoteDate').value || '';
            document.getElementById('previewCustomer').textContent = getCustomerName() || 'ï¼ˆé¡§å®¢åï¼‰';
            document.getElementById('previewAmount').textContent = formatCurrency(calculateExpenses());
            document.getElementById('previewProject').textContent = document.getElementById('projectName').value || '';
            document.getElementById('previewSite').textContent = document.getElementById('siteAddress').value || '';
            const s = getPeriodValue('periodStart'), e = getPeriodValue('periodEnd');
            document.getElementById('previewPeriod').textContent = s&&e ? `${s} ï½ ${e}` : '';
            document.getElementById('previewOffice').textContent = document.getElementById('office').value || '';
        }

        // ===== ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ =====
        function loadSampleData() {
            categories = [
                { id: 1, name: 'ä»®è¨­å·¥äº‹', items: [{no:1,name:'ä»®å›²ã„è¨­ç½®',spec:'H=3m',qty:150,unit:'m',price:3000,note:''},{no:2,name:'ä»®è¨­é›»æ°—',spec:'',qty:1,unit:'å¼',price:200000,note:''},{no:3,name:'ä»®è¨­æ°´é“',spec:'',qty:1,unit:'å¼',price:150000,note:''}]},
                { id: 2, name: 'è§£ä½“å·¥äº‹', items: [{no:1,name:'å»ºå±‹è§£ä½“',spec:'é‰„éª¨é€ ',qty:500,unit:'ã¡',price:8000,note:''},{no:2,name:'åŸºç¤è§£ä½“',spec:'RC',qty:200,unit:'ã¥',price:12000,note:''},{no:3,name:'é…ç®¡æ’¤å»',spec:'Ï†100ã€œ300',qty:500,unit:'m',price:4000,note:''}]},
                { id: 3, name: 'ç”£å»ƒå‡¦ç†', items: [{no:1,name:'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã‚¬ãƒ©',spec:'',qty:300,unit:'t',price:5000,note:''},{no:2,name:'é‡‘å±ããš',spec:'',qty:50,unit:'t',price:-10000,note:'æœ‰ä¾¡ç‰©'},{no:3,name:'æ··åˆå»ƒæ£„ç‰©',spec:'',qty:100,unit:'t',price:25000,note:''}]}
            ];
            categoryId = 3;
            renderCategories();
            calculateExpenses();
        }

        // ===== è¨­å®š =====
        function changePassword() {
            const newPw = document.getElementById('newPassword').value;
            if (!newPw) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            const u = users.find(x => x.empId === currentUser.empId);
            if (u) { u.password = newPw; currentUser.password = newPw; saveToLocalStorage(); alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); }
        }
        function exportAllData() {
            const data = { users, estimates, notifications, customers };
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `besterra_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
        }
        function importAllData() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.users) users = data.users;
                        if (data.estimates) estimates = data.estimates;
                        if (data.notifications) notifications = data.notifications;
                        if (data.customers) customers = data.customers;
                        saveToLocalStorage(); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); location.reload();
                    } catch(err) { alert('ã‚¨ãƒ©ãƒ¼: ' + err.message); }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }
        function clearAllData() {
            if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear(); location.reload();
            }
        }
        function exportCSV() {
            let csv = '\uFEFF';
            csv += `é¡§å®¢å,${getCustomerName()}\n`;
            csv += `å·¥äº‹å,${document.getElementById('projectName').value}\n\n`;
            csv += 'No,ä¸­é …ç›®,åç§°,æ•°é‡,å˜ä½,å˜ä¾¡,é‡‘é¡\n';
            categories.forEach(c => c.items.forEach(i => { if(i.name) csv += `${i.no},${c.name},${i.name},${i.qty},${i.unit},${i.price},${(parseFloat(i.qty)||0)*(parseFloat(i.price)||0)}\n`; }));
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `è¦‹ç©_${document.getElementById('projectName').value||'æ–°è¦'}.csv`; a.click();
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function formatCurrency(n) { return 'Â¥' + Math.round(n||0).toLocaleString(); }
        function formatNumber(n) { return n ? Math.round(n).toLocaleString() : ''; }

        // ===== ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« =====
        function toggleHelp() {
            document.getElementById('helpPanel').classList.toggle('active');
            document.getElementById('helpOverlay').classList.toggle('active');
        }

        // ===== æœŸé–“ã‚»ãƒ¬ã‚¯ãƒˆ =====
        function initPeriodSelects() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let y = currentYear - 1; y <= currentYear + 5; y++) years.push(y);

            ['periodStartYear', 'periodEndYear'].forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">--</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            });

            ['periodStartMonth', 'periodEndMonth'].forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">--</option>' + Array.from({length:12}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
            });

            ['periodStartDay', 'periodEndDay'].forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">--</option>' + Array.from({length:31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
            });
        }

        function getPeriodValue(prefix) {
            const y = document.getElementById(prefix + 'Year').value;
            const m = document.getElementById(prefix + 'Month').value;
            const d = document.getElementById(prefix + 'Day').value;
            if (!y || !m || !d) return '';
            return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }

        function setPeriodValue(prefix, dateStr) {
            if (!dateStr) {
                document.getElementById(prefix + 'Year').value = '';
                document.getElementById(prefix + 'Month').value = '';
                document.getElementById(prefix + 'Day').value = '';
                return;
            }
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                document.getElementById(prefix + 'Year').value = parseInt(parts[0]);
                document.getElementById(prefix + 'Month').value = parseInt(parts[1]);
                document.getElementById(prefix + 'Day').value = parseInt(parts[2]);
            }
        }

        function updatePeriodPreview() {
            // æœŸé–“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆä¿å­˜æ™‚ã«ä½¿ç”¨ï¼‰
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ =====
        const stepGuideData = {
            'basic': {
                description: 'ã¾ãšã€é¡§å®¢å…ˆåã¨å·¥äº‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å·¥äº‹æœŸé–“ã‚‚è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚',
                nextTitle: 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                nextDesc: 'å¿…é ˆé …ç›®ï¼ˆ*ï¼‰ã‚’å…¥åŠ›ã—ãŸã‚‰ã€Œ2. åŸä¾¡å…¥åŠ›ã€ã‚¿ãƒ–ã¸é€²ã¿ã¾ã—ã‚‡ã†',
                dots: [1, 0, 0, 0]
            },
            'cost': {
                description: 'å·¥äº‹ã®åŸä¾¡ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã€Œä¸­é …ç›®è¿½åŠ ã€ã§é …ç›®ã‚’ä½œæˆã—ã€æ˜ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                nextTitle: 'å…¥åŠ›ã®ã‚³ãƒ„',
                nextDesc: 'ã€Œã‚µãƒ³ãƒ—ãƒ«èª­è¾¼ã€ã§å…¥åŠ›ä¾‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚æ•°é‡Ã—å˜ä¾¡ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™',
                dots: [2, 1, 0, 0]
            },
            'expense': {
                description: 'çµŒè²»ã®ç‡ã‚’ç¢ºèªãƒ»èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç›´æ¥å·¥äº‹è²»ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚',
                nextTitle: 'ç¢ºèªãƒã‚¤ãƒ³ãƒˆ',
                nextDesc: 'ç‡ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•ã§å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚å•é¡Œãªã‘ã‚Œã°ã€Œ4. ç¢ºèªãƒ»å‡ºåŠ›ã€ã¸',
                dots: [2, 2, 1, 0]
            },
            'output': {
                description: 'è¦‹ç©å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚å•é¡Œãªã‘ã‚Œã°ä¿å­˜ã—ã¦æ‰¿èªç”³è«‹ã§ãã¾ã™ã€‚',
                nextTitle: 'æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—',
                nextDesc: 'ã€Œä¿å­˜ã€ã§ä¸‹æ›¸ãä¿å­˜ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¬„ã‹ã‚‰ã€Œæ‰¿èªç”³è«‹ã€ãŒã§ãã¾ã™',
                dots: [2, 2, 2, 1]
            }
        };

        function updateStepGuide(tabName) {
            const data = stepGuideData[tabName];
            if (!data) return;

            document.getElementById('stepDescription').textContent = data.description;
            document.getElementById('nextActionTitle').textContent = data.nextTitle;
            document.getElementById('nextActionDesc').textContent = data.nextDesc;

            data.dots.forEach((state, i) => {
                const dot = document.getElementById('dot' + (i + 1));
                dot.className = 'step-dot';
                if (state === 1) dot.classList.add('active');
                else if (state === 2) dot.classList.add('done');
            });
        }

        // ===== é¡§å®¢ç®¡ç† =====
        function renderCustomerList() {
            const tbody = document.getElementById('customer-list');
            tbody.innerHTML = customers.map(c => `
                <tr>
                    <td>${c.code}</td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.address || '-'}</td>
                    <td>${c.tel || '-'}</td>
                    <td>${c.contact || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="openCustomerModal(${c.id})">ç·¨é›†</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${c.id})">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function openCustomerModal(customerId = null) {
            editingCustomerId = customerId;
            if (customerId) {
                const c = customers.find(x => x.id === customerId);
                document.getElementById('customerModalTitle').textContent = 'é¡§å®¢ç·¨é›†';
                document.getElementById('custCode').value = c.code || '';
                document.getElementById('custCode').disabled = true;
                document.getElementById('custName').value = c.name || '';
                document.getElementById('custKana').value = c.kana || '';
                document.getElementById('custZip').value = c.zip || '';
                document.getElementById('custAddress').value = c.address || '';
                document.getElementById('custTel').value = c.tel || '';
                document.getElementById('custEmail').value = c.email || '';
                document.getElementById('custContact').value = c.contact || '';
            } else {
                document.getElementById('customerModalTitle').textContent = 'é¡§å®¢è¿½åŠ ';
                document.getElementById('custCode').value = '';
                document.getElementById('custCode').disabled = false;
                document.getElementById('custName').value = '';
                document.getElementById('custKana').value = '';
                document.getElementById('custZip').value = '';
                document.getElementById('custAddress').value = '';
                document.getElementById('custTel').value = '';
                document.getElementById('custEmail').value = '';
                document.getElementById('custContact').value = '';
            }
            document.getElementById('customerModal').classList.add('active');
        }

        async function saveCustomer() {
            const code = document.getElementById('custCode').value.trim();
            const name = document.getElementById('custName').value.trim();

            if (!code || !name) {
                alert('é¡§å®¢ã‚³ãƒ¼ãƒ‰ã¨é¡§å®¢åã¯å¿…é ˆã§ã™');
                return;
            }

            const customerData = {
                code: code,
                name: name,
                kana: document.getElementById('custKana').value.trim(),
                zip: document.getElementById('custZip').value.trim(),
                address: document.getElementById('custAddress').value.trim(),
                tel: document.getElementById('custTel').value.trim(),
                email: document.getElementById('custEmail').value.trim(),
                contact: document.getElementById('custContact').value.trim()
            };

            try {
                if (editingCustomerId) {
                    // æ›´æ–°
                    const { error } = await supabase.from('customers').update(customerData).eq('id', editingCustomerId);
                    if (error) throw error;

                    const c = customers.find(x => x.id === editingCustomerId);
                    Object.assign(c, customerData);
                } else {
                    // æ–°è¦ä½œæˆ
                    if (customers.find(c => c.code === code)) {
                        alert('ã“ã®é¡§å®¢ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
                        return;
                    }

                    const { data, error } = await supabase.from('customers').insert(customerData).select().single();
                    if (error) throw error;

                    customers.push({ id: data.id, ...customerData });
                }

                closeModal('customerModal');
                renderCustomerList();
                alert('ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('é¡§å®¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteCustomer(customerId) {
            if (confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const { error } = await supabase.from('customers').delete().eq('id', customerId);
                    if (error) throw error;

                    customers = customers.filter(c => c.id !== customerId);
                    renderCustomerList();
                } catch (error) {
                    console.error('é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }

        function populateCustomerSelect() {
            const sel = document.getElementById('customerSelect');
            sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}ï¼ˆ${c.code}ï¼‰</option>`).join('');
        }

        function updateCustomerInfo() {
            const customerId = parseInt(document.getElementById('customerSelect').value);
            const info = document.getElementById('customerInfo');
            if (!customerId) {
                info.innerHTML = '-';
                return;
            }
            const c = customers.find(x => x.id === customerId);
            if (c) {
                info.innerHTML = `ã€’${c.zip || '-'}<br>${c.address || '-'}<br>TEL: ${c.tel || '-'}<br>æ‹…å½“: ${c.contact || '-'}`;
            } else {
                info.innerHTML = '-';
            }
        }

        function getCustomerName() {
            const customerId = parseInt(document.getElementById('customerSelect').value);
            const c = customers.find(x => x.id === customerId);
            return c ? c.name : '';
        }
    </script>
</body>
</html>
